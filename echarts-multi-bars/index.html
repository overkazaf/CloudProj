<!DOCTYPE html>
<html>

<head>
    <title>MultiCharts</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
    <div class="main clearfix">
        <nav class="nav fl">
            <ul id="tab-list">
                <li class="tab-list-item header-item">网贷指数</li>
            </ul>
        </nav>
        <div class="charts fl">
            <div class="deal-container">
                <p class="deal">
                    成交：
                    <span class="num" id="turnover">
						{{turnover}}
					</span> 利率：
                    <span class="num" id="exponent">
						{{exponent}}
					</span>人气：<span class="num" id="outcount">
						{{outcount}}
					</span>
                </p>
            </div>
            <div id="tab-conatiner">
            </div>
        </div>
    </div>
    <script src="node_modules/echarts/dist/echarts.min.js"></script>
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script>
    $(function() {
        var APP = {
            DEBUG: true,
            BASE_INTERFACE: 'http://localhost:3000',
            FILE_PATH: {
                exponent: 'exponent.json',
                dangan: 'dangan_search.json',
                exponentChart10: 'exponent-chart-10.json'
            },
            DATA: {
                exponent: {},
                dangan: [],
                exponentChart10: []
            },
            DEALS: ['turnover', 'exponent', 'outcount'],
            TAB_ID: '#tab-list',
            TAB_CONTAINER_ID: '#tab-conatiner',
            PLAT_IDS: {
                57: '人人贷',
                52: '拍拍贷',
                60: '红岭创投',
                59: '陆金所',
                85: '宜人贷',
                116: '开鑫贷',
                689: '爱钱进',
                38: '微贷网',
                142: '有利网',
                984: '金宝保',
                942: '易贷网',
                129: '点融网'
            },
            chartList: []
        };


        function initApp() {
            test();
            renderTab(initTabEvents);

            setTimeout(function() {
                renderDeal();
                batchRenderCharts();
            }, 0);

        };


        initApp();

        function batchRenderCharts () {
        	for (var id in APP.PLAT_IDS) {
        		renderChart(id, APP.PLAT_IDS[id]);
        	}
        }

        function renderDeal() {
            var data = APP.DATA['exponent'];
            for (var i = 0, deals = APP.DEALS, l = deals.length; i < l; i++) {
                var id = deals[i];
                $('#' + id).text(data[id])
            }
        }

        function renderTab(callback) {
            var tpl = '',
                containerTpl = '';

            for (var id in APP.PLAT_IDS) {
                var name = APP.PLAT_IDS[id];
                tpl += '<li class="tab-list-item"><a href="#">' + name + '</a></li>';


                containerTpl += '<div id="' + id + '" class="tab-container-item">' + name + '</div>';
            }

            $(APP.TAB_ID).append(tpl);
            $(APP.TAB_CONTAINER_ID).html(containerTpl);

            callback && callback();
        }

        function initTabEvents() {
            var $containers = $(APP.TAB_CONTAINER_ID).find('.tab-container-item');
            $(APP.TAB_ID).on('mouseenter', 'li', function(ev) {
                var $target = $(ev.target);
                var index = $target.index();
                log('index', index);

                $containers.hide().eq(index).show();

            });

            $(APP.TAB_ID).find('li:first').trigger('mouseenter');
        }



        function getMixedBarOptions(json) {
            var option = {
                tooltip: {
                    trigger: 'axis'
                },
                toolbox: {
                    feature: {
                        dataView: {
                            show: true,
                            readOnly: false
                        },
                        magicType: {
                            show: true,
                            type: ['line', 'bar']
                        },
                        restore: {
                            show: true
                        },
                        saveAsImage: {
                            show: true
                        }
                    }
                },
                legend: {
                    data: ['蒸发量', '降水量', '平均温度']
                },
                xAxis: [{
                    type: 'category',
                    data: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月']
                }],
                yAxis: [{
                    type: 'value',
                    name: '水量',
                    min: 0,
                    max: 250,
                    interval: 50,
                    axisLabel: {
                        formatter: '{value} ml'
                    }
                }, {
                    type: 'value',
                    name: '温度',
                    min: 0,
                    max: 25,
                    interval: 5,
                    axisLabel: {
                        formatter: '{value} °C'
                    }
                }],
                series: [{
                    name: '蒸发量',
                    type: 'bar',
                    data: [2.0, 4.9, 7.0, 23.2, 25.6, 76.7, 135.6, 162.2, 32.6, 20.0, 6.4, 3.3]
                }, {
                    name: '降水量',
                    type: 'bar',
                    data: [2.6, 5.9, 9.0, 26.4, 28.7, 70.7, 175.6, 182.2, 48.7, 18.8, 6.0, 2.3]
                }, {
                    name: '平均温度',
                    type: 'line',
                    yAxisIndex: 1,
                    data: [2.0, 2.2, 3.3, 4.5, 6.3, 10.2, 20.3, 23.4, 23.0, 16.5, 12.0, 6.2]
                }]
            };

            return option;
        }

        function getChartOption(id, json) {
            var option = null;
            switch (id) {
                case 0:
                    option = getMixedBarOptions();
                    break;
				default: 
					option = getMixedBarOptions();
            }

            return option;
        }


        function paserStockData (data) {
        	return data;
        }

        function renderChart(id, name) {
            var data = APP.DATA['exponentChart10'];
            $.each(data, function(i, item) {
            	log('item.platId', item.platId);
                if (item.platId == id) {
                    var json = paserStockData(item.data);
                    if (!$("#" + id).attr('data-init')) {
                    	var dom = document.getElementById(id);
	                    var chartEl = echarts.init(document.getElementById('chart'));
                        setTimeout(function (){

	                        APP.chartList.push(chartEl);


	                        var option = getChartOption(id, json);

	                        chartEl.setOption(option);
                        }, 500);

                        $("#" + id).attr('data-init', true);
                    }
                    return;
                }
            });
        }

        function getFilePath(fileName) {
            return APP.BASE_INTERFACE + '/file/' + fileName;
        }

        function getJSON(fileName) {
            return $.getJSON(getFilePath(fileName));
        }

        // getJSON(APP.FILE_PATH['exponent']).then(function (data){
        // 	log('result', data);
        // });

        function test() {
            for (var f in APP.FILE_PATH) {
                + function(fileId) {
                    getJSON(APP.FILE_PATH[fileId]).then(function(data) {
                        APP.DATA[fileId] = data;
                    });
                }(f);
            }
        }




        function log(k, v) {
            if (APP.DEBUG) {
                console.log(k, v);
            }
        }
    });
    </script>
</body>

</html>
